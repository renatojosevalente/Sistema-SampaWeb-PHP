<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../estilo/estilo.css">
    <title>Gráfico de Pontuação por Aluno</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        #chartContainer {
            max-width: 1280px;
            margin: 0 auto;
            overflow-y: auto;
        }
        canvas {
            margin-top: 20px;
            height: 800px !important;
        }
    </style>
</head>
<body>
    <header>
        <img src="../imagens/sampaweb_logo.png" alt="Logo de Login" class="logo">
        <h1>Gráfico de Pontuação por Aluno - SAMPA 2024</h1>
        <p><strong>Escola: Todas as escolas municipais</strong></p>
        <p><strong>Disciplina: LÍNGUA PORTUGUESA</strong></p>
    </header>

    <hr>
    
    <div id="chartContainer">
         
        <canvas id="graficoHorizontal"></canvas>
    </div>
    <button onclick="prevPage()">Anterior</button>
    <button onclick="nextPage()">Próximo</button>
    <button onclick="downloadImage()">Baixar Gráfico (PNG)</button>
    <a href="../index.php" class="linkacesso-link">Sair do sistema</a>

    <script>
        let resultados = [];
        let currentPage = 0;
        const itemsPerPage = 10;

        async function fetchResultados() {
            try {
                const response = await fetch('api_resultado_lp.php');
                const data = await response.json();

                if (data.status === 'success') {
                    resultados = data.data;
                    criarGrafico();
                } else {
                    console.error(data.message);
                    alert('Erro ao buscar dados: ' + data.message);
                }
            } catch (error) {
                console.error(error);
                alert('Erro na requisição dos dados.');
            }
        }

        function getColorByClassification(classification) {
            switch (classification) {
                case 'Insatisfatório': return 'rgba(255, 99, 132, 0.8)';
                case 'Regular': return 'rgba(255, 165, 0)';
                case 'Satisfatório': return 'rgba(75, 192, 192, 0.8)';
                case 'Plenamente Satisfatório': return 'rgba(54, 162, 235, 0.8)';
                default: return 'rgba(201, 203, 207, 0.8)';
            }
        }

        function criarGrafico() {
            const start = currentPage * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = resultados.slice(start, end);

            const labels = pageData.map(res => `${res.nomeAluno}\n(${res.nomeClasse}, ${res.nomeDisciplina}, ${res.nomeEscola})`);
            const pontuacoes = pageData.map(res => res.pontuacaoAluno);
            const acertos = pageData.map(res => res.acertos);
            const erros = pageData.map(res => res.erros);
            const classificacoes = pageData.map(res => res.classificacao);

            const colors = classificacoes.map(classificacao => getColorByClassification(classificacao));

            const ctx = document.getElementById('graficoHorizontal').getContext('2d');
            if (window.myChart) {
                window.myChart.destroy();
            }
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Pontuação',
                            data: pontuacoes,
                            backgroundColor: colors,
                            borderColor: colors.map(color => color.replace('0.8', '1')),
                            borderWidth: 1
                        },
                        {
                            label: 'Acertos',
                            data: acertos,
                            backgroundColor: 'rgba(75, 192, 192, 0.8)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            stack: 'ErroAcerto'
                        },
                        {
                            label: 'Erros',
                            data: erros,
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1,
                            stack: 'ErroAcerto'
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                afterLabel: function (context) {
                                    return `Classificação: ${classificacoes[context.dataIndex]}`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: [
                            `Nível de Proficiência, Acertos e Erros por Aluno - Página ${currentPage + 1} `,``,
                            `Passe o mouse na barra do gráfico para visualizar mais informações.`
                            ],
                            font: { size: 20 },
                            padding: { top: 40, bottom: 20 }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, max: 100 },
                        y: { stacked: true }
                    }
                }
            });
        }

        function prevPage() {
            if (currentPage > 0) {
                currentPage--;
                criarGrafico();
            }
        }

        function nextPage() {
            if ((currentPage + 1) * itemsPerPage < resultados.length) {
                currentPage++;
                criarGrafico();
            }
        }

        function downloadImage() {
            const canvas = document.getElementById('graficoHorizontal');
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = `grafico_pontuacao_pagina_${currentPage + 1}.png`;
            link.click();
        }

        fetchResultados();
    </script>

    <footer>
        <p>Sistema desenvolvido por: <strong>Renato José Valente &reg - Ano 2025</strong></p>
    </footer>
</body>
</html>
